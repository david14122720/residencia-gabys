---
const slides = [
    {
        src: "/img1.webp",
        alt: "Vista frontal de Residencia Gabys",
        caption: "Residencia",
    },
    {
        src: "/img3.webp",
        alt: "Entrada principal de la residencia Gabys",
        caption: "Entrada principal de la residencia",
    },
    {
        src: "/img5.webp",
        alt: "Habitación con baño privado en Residencia Gabys",
        caption: "Habitaciones",
    },
    {
        src: "/img6.webp",
        alt: "Habitación cómoda en Residencia Gabys",
        caption: "Habitaciones",
    },
    {
        src: "/img7.webp",
        alt: "Espaciosa sala de estar de Residencia Gabys",
        caption: "Sala de estar",
    },
];
---

<section
    class="bg-light-gray py-16 md:py-24"
    id="galeria"
    aria-labelledby="galeria-heading"
>
    <div class="max-w-7xl mx-auto px-6 font-body">
        <div class="text-center mb-12">
            <h2
                id="galeria-heading"
                class="section-title text-4xl md:text-5xl font-bold text-primary-red mb-8 tracking-tight"
            >
                Nuestra Residencia
            </h2>
            <p
                class="max-w-2xl mx-auto text-dark-gray text-lg md:text-xl leading-relaxed"
            >
                Conoce nuestras instalaciones cómodas y acogedoras. Un lugar
                perfecto para descansar durante tu viaje.
            </p>
        </div>

        <!-- Carousel -->
        <figure
            class="relative max-w-[960px] mx-auto overflow-hidden rounded-2xl shadow-2xl border border-white/30"
            role="region"
            aria-label="Galería de imágenes de la residencia"
        >
            <div class="carousel-track" id="carousel">
                {
                    slides.map((slide, i) => (
                        <article class="carousel-slide">
                            <img
                                src={
                                    i === 0
                                        ? slide.src
                                        : `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 4 3'%3E%3C/svg%3E`
                                }
                                data-src={slide.src}
                                alt={slide.alt}
                                class:list={[
                                    "w-full h-[320px] md:h-[480px] object-cover",
                                    i > 0 && "lazy-img",
                                ]}
                                loading={i === 0 ? "eager" : "lazy"}
                                decoding="async"
                            />
                            <figcaption class="absolute bottom-0 left-0 right-0 bg-black/70 text-white py-4 px-5 text-center text-base md:text-lg font-medium backdrop-blur-sm">
                                {slide.caption}
                            </figcaption>
                        </article>
                    ))
                }
            </div>

            <button
                class="carousel-btn left-3 md:left-6"
                id="prevBtn"
                aria-label="Imagen anterior"
            >
                <i class="fas fa-chevron-left" aria-hidden="true"></i>
            </button>
            <button
                class="carousel-btn right-3 md:right-6"
                id="nextBtn"
                aria-label="Imagen siguiente"
            >
                <i class="fas fa-chevron-right" aria-hidden="true"></i>
            </button>

            <div
                class="flex justify-center gap-3 py-5 bg-white/60"
                id="carouselIndicators"
                role="tablist"
                aria-label="Indicadores del carrusel"
            >
                <!-- Indicators generated by JS -->
            </div>
        </figure>

        <p
            class="text-center mt-8 italic text-dark-gray text-base md:text-lg font-medium"
        >
            Desliza para ver más fotos de nuestras instalaciones
        </p>
    </div>
</section>

<script define:vars={{ totalSlides: slides.length }}>
    // Carousel logic
    const carousel = document.getElementById("carousel");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    const carouselIndicators = document.getElementById("carouselIndicators");

    let currentSlide = 0;

    // Create indicators
    for (let i = 0; i < totalSlides; i++) {
        const indicator = document.createElement("button");
        indicator.classList.add("indicator", "bg-medium-gray");
        indicator.setAttribute("role", "tab");
        indicator.setAttribute("aria-label", `Ir a imagen ${i + 1}`);
        indicator.setAttribute("aria-selected", i === 0 ? "true" : "false");
        if (i === 0) indicator.classList.add("active");
        indicator.dataset.index = i;
        indicator.addEventListener("click", () => goToSlide(i));
        carouselIndicators.appendChild(indicator);
    }

    function goToSlide(n) {
        currentSlide = (n + totalSlides) % totalSlides;
        carousel.style.transform = `translateX(-${currentSlide * 100}%)`;
        document.querySelectorAll(".indicator").forEach((ind, index) => {
            const isActive = index === currentSlide;
            ind.classList.toggle("active", isActive);
            ind.setAttribute("aria-selected", isActive ? "true" : "false");
        });
    }

    prevBtn.addEventListener("click", () => goToSlide(currentSlide - 1));
    nextBtn.addEventListener("click", () => goToSlide(currentSlide + 1));

    // Auto-carousel (smart: pause when not visible)
    let carouselInterval;
    function startCarousel() {
        if (carouselInterval) return;
        carouselInterval = setInterval(() => goToSlide(currentSlide + 1), 6000);
    }
    function stopCarousel() {
        clearInterval(carouselInterval);
        carouselInterval = null;
    }

    const observer = new IntersectionObserver(
        (entries) => {
            entries.forEach((entry) => {
                if (entry.isIntersecting) startCarousel();
                else stopCarousel();
            });
        },
        { threshold: 0.5 },
    );

    observer.observe(document.querySelector(".carousel-track").parentElement);

    // Touch swipe support (mobile)
    let touchStartX = 0;
    let touchEndX = 0;
    const carouselEl = document.querySelector(".carousel-track").parentElement;

    carouselEl.addEventListener(
        "touchstart",
        (e) => {
            touchStartX = e.changedTouches[0].screenX;
        },
        { passive: true },
    );

    carouselEl.addEventListener(
        "touchend",
        (e) => {
            touchEndX = e.changedTouches[0].screenX;
            const diff = touchStartX - touchEndX;
            if (Math.abs(diff) > 50) {
                if (diff > 0) goToSlide(currentSlide + 1);
                else goToSlide(currentSlide - 1);
            }
        },
        { passive: true },
    );

    // Lazy loading images
    const lazyImages = document.querySelectorAll(".lazy-img");
    const imgObserver = new IntersectionObserver(
        (entries, obs) => {
            entries.forEach((entry) => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    img.src = img.dataset.src;
                    img.classList.add("fade-in");
                    obs.unobserve(img);
                }
            });
        },
        { rootMargin: "150px" },
    );

    lazyImages.forEach((img) => imgObserver.observe(img));
</script>
